<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AttendIQ Check-in</title>
    <link rel="stylesheet" href="css/style.css">
</head>
<body style="display:flex;align-items:center;justify-content:center;min-height:100vh;">
    <div class="glass-card" style="max-width:520px;width:100%;padding:24px;">
        <h2 class="gradient-title" style="font-size:1.6rem;">üéØ FANG Level Check‚Äëin</h2>
        <div id="status" style="margin:10px 0;color:var(--gray-text);">Ready to mark attendance</div>
        
        <div class="glass-display" style="text-align:left;">
            <p style="color:var(--gray-text);font-size:0.9rem;margin-bottom:15px;">
                üî• Real functional QR scanning system
            </p>
            <button id="checkBtn" class="btn btn-primary btn-3d" style="width:100%;">
                ‚úÖ Mark My Attendance
            </button>
        </div>
    </div>

    <script>
        function getParam(name){ const u = new URL(location.href); return u.searchParams.get(name); }
        const token = getParam('t');
        const session = getParam('session');
        const statusEl = document.getElementById('status');

        // Handle different entry methods
        if (!token && !session){
            statusEl.innerHTML = '<span style="color:#ef4444;">‚ö†Ô∏è Invalid or missing session information.</span><br><span>Please scan a valid QR code.</span>';
            const backBtn = document.createElement('button');
            backBtn.className = 'btn btn-secondary';
            backBtn.style.marginTop = '15px';
            backBtn.textContent = 'Back to Dashboard';
            backBtn.addEventListener('click', () => window.location.href = 'student-dashboard.html');
            statusEl.appendChild(backBtn);
        }

        let myGeo = null;
        navigator.geolocation.getCurrentPosition(p=>{
            myGeo = {lat:p.coords.latitude, lon:p.coords.longitude};
        }, ()=>{ myGeo = null; });

        document.getElementById('checkBtn').addEventListener('click', async ()=>{
            const studentEmail = localStorage.getItem('userData') ? 
                JSON.parse(localStorage.getItem('userData')).email : null;
            
            if (!studentEmail) { 
                alert('Please login first as a student'); 
                window.location.href = 'login.html';
                return; 
            }

            // Get session ID from URL parameters
            const urlParams = new URLSearchParams(window.location.search);
            const sessionId = urlParams.get('sessionId') || session;
            
            if (!sessionId) { 
                alert('Invalid session. Please scan a valid QR code.'); 
                return; 
            }

            statusEl.innerHTML = 'üîÑ Marking attendance...';
            
            try {
                // Real API call to mark attendance
                const response = await fetch('http://localhost:5000/api/student/mark-attendance', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${localStorage.getItem('authToken')}`
                    },
                    body: JSON.stringify({
                        sessionId: sessionId,
                        studentEmail: studentEmail,
                        timestamp: new Date().toISOString(),
                        location: myGeo
                    })
                });

                const result = await response.json();

                if (response.ok && result.success) {
                    // Success - show beautiful success page
                    showSuccessPage(result.studentName, result.subject, result.status, result.timestamp);
                } else {
                    statusEl.innerHTML = `<span style="color:#ef4444;">‚ùå ${result.error || 'Failed to mark attendance'}</span>`;
                }
            } catch (error) {
                console.error('Attendance error:', error);
                statusEl.innerHTML = '<span style="color:#ef4444;">‚ùå Connection error. Please try again.</span>';
            }
        });

        function showSuccessPage(studentName, subject, status, timestamp) {
            document.body.innerHTML = `
                <div class="glass-card" style="max-width:600px;width:100%;padding:40px;text-align:center;margin:20px auto;">
                    <div style="font-size:4rem;margin-bottom:20px;">‚úÖ</div>
                    <h2 class="gradient-title" style="font-size:2rem;margin-bottom:30px;">Attendance Marked Successfully!</h2>
                    
                    <div class="glass-display" style="margin:30px 0;padding:25px;text-align:left;">
                        <div style="display:grid;gap:15px;">
                            <div><strong>üë§ Student:</strong> ${studentName}</div>
                            <div><strong>üìö Subject:</strong> ${subject}</div>
                            <div><strong>‚úÖ Status:</strong> <span style="color:#10b981;font-weight:600;">${status.toUpperCase()}</span></div>
                            <div><strong>‚è∞ Time:</strong> ${new Date(timestamp).toLocaleString()}</div>
                            <div><strong>üìç Session:</strong> Valid QR scan verified</div>
                        </div>
                    </div>

                    <div style="margin-top:30px;display:flex;gap:15px;justify-content:center;flex-wrap:wrap;">
                        <button onclick="window.location.href='student-dashboard.html'" class="btn btn-primary btn-3d">
                            üè† Back to Dashboard
                        </button>
                        <button onclick="window.location.href='login.html'" class="btn btn-secondary btn-3d">
                            üëã Logout
                        </button>
                    </div>

                    <div style="margin-top:20px;padding:15px;background:rgba(16,185,129,0.1);border-radius:10px;border:1px solid #10b981;">
                        <p style="margin:0;color:#10b981;font-weight:500;">
                            üéâ Your attendance has been recorded successfully!
                        </p>
                    </div>
                </div>
            `;
        }

        // Handle QR scan URL parameters  
        window.addEventListener('load', () => {
            const urlParams = new URLSearchParams(window.location.search);
            const qrData = urlParams.get('data');
            
            if (qrData) {
                try {
                    const parsedData = JSON.parse(decodeURIComponent(qrData));
                    if (parsedData.sessionId) {
                        statusEl.innerHTML = `‚úÖ QR Scanned Successfully<br>Session: ${parsedData.sessionId}<br>Subject: ${parsedData.subject}`;
                        // Auto-trigger check-in for QR scans
                        setTimeout(() => {
                            document.getElementById('checkBtn').click();
                        }, 1000);
                    }
                } catch (error) {
                    console.error('Error parsing QR data:', error);
                }
            }
        });
    </script>
</body>
</html>